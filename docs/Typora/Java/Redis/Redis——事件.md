[TOC]

# Redis——事件

Redis服务器是一个事件驱动程序，服务器需要处理两类事件：

1. 文件事件：文件事件是**服务器对套接字操作的抽象**
1. 时间事件：时间事件是服务器对**定时操作的抽象**

## 文件事件

### 文件事件处理器模型

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/9ea86eb5-000a-4281-b948-7b567bd6f1d8.png)

<center>文件事件处理器的四个组成部分

该文件事件处理器是Redis基于Reactor模式开发的自己的网络事件处理器

使用IO多路复用程序来同时监听多个套接字，并为套接字关联对应的事件处理器

1. 产生文件事件的套接字会被放到一个队列里，然后IO多路复用程序通过这个队列向文件事件分派器传送套接字

   ![image-20200731155550503](http://java-guide.oss-cn-hangzhou.aliyuncs.com/typora/20200731155552-564806.png)

2. 文件事件分为`AE_READABLE`事件（读事件）和`AE_WRITABLE`事件（写事件）两类
2. 每个事件处理器都是一个**函数**，定义了事件发生时，服务器应该执行的动作

### IO多路复用程序

Redis中的IO多路复用程序的功能是通过包装`select`、`epoll`等I/O多路复用库来实现的

![image-20200731160535466](http://java-guide.oss-cn-hangzhou.aliyuncs.com/typora/20200731160540-82853.png)

<center>Redis的I/O多路复用程序有多个I/O多路复用库可选

I/O多路复用程序会在编译时**自动选择系统中性能最高的I/O多路复用库来作为底层的实现**

### 事件处理器

* 连接应答处理器
* 命令请求处理器
* 命令回复处理器
* 主从服务器之间复制的处理器

在这些事件处理器中，最常用的是前三种

## 时间事件

时间事件分为两类：

* 定时事件：让一段程序在指定的时间之后执行一次
* 周期性事件：让一段程序每隔指定的时间就执行一次

### 时间事件的组成

一个时间事件主要由以下三个属性组成

* `id`：服务器为时间事件创建的全局唯一ID
* `when`：时间戳，记录了时间事件的到达时间
* `timeProc`：时间事件处理器

**时间事件处理器的返回值**决定了这个时间事件是定时事件还是周期性事件

### 实现

服务器会将所有时间事件放在一个**无序链表**中，当**时间事件执行器**运行时，会遍历整个链表，查找所有已到达的时间事件，并调用相应的事件处理器

![image-20200731173544923](http://java-guide.oss-cn-hangzhou.aliyuncs.com/typora/20200731173546-758240.png)

<center>保存时间事件的链表

无序链表是指：链表按ID逆序排序，但不按`when`属性的大小排序

## 事件的调度和执行

事件调度与执行由 `aeProcessEvents` 函数负责

从事件处理的角度来看，服务器运行流程如下：

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/c0a9fa91-da2e-4892-8c9f-80206a6f7047.png)

* 文件事件和时间事件之间是合作关系，服务器会轮流处理这两种事件，并且处理事件的过程中也不会发生抢占
* 时间事件的实际处理时间通常会比设定的到达时间晚一些