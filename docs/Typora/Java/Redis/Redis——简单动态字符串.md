# Redis——简单动态字符串

在Redis里，C字符串只会作为字符串字面量；默认字符串表示是一种名为简单动态字符串（SDS）的抽象类型

## C字符串和SDS之间的区别

![image-20200720202706677](http://java-guide.oss-cn-hangzhou.aliyuncs.com/typora/20200720202709-969883.png)

相比C字符串，SDS有以下优点：

* 获取字符串长度为 O(N) 级别的操作
* 杜绝缓冲区溢出
* 减少修改字符串长度时所需的内存重分配次数
* 二进制安全
* 兼容部分C字符串函数

接下来开始描述这些优点是如何做到的

## SDS的定义

```c
struct sdshdr{
    //记录buf数组中已使用字节的数量
    //等于SDS所保存字符串的长度
    int len;
    
    //记录buf数组中未使用字节的数量
    int free;
    
    //字节数组，用于保存字符串
    char buf[];
}
```

### 常数时间内获取字符串长度

只需要访问SDS的`len`属性，并且设置和更新SDS长度的工作是由SDS的API在执行时自动完成的

### 杜绝缓冲区溢出

得益于SDS的空间分配策略

当SDS的API需要对SDS进行修改时，会先检查SDS的空间是否满足修改要求，如果不满足，API会自动扩展SDS空间，然后才执行实际的修改操作

### 减少修改字符串长度时所需的内存重分配次数

实现了两种优化策略

1. 空间预分配

   空间预分配用于优化SDS的字符串增长操作：当SDS的API对一个SDS进行修改，并且需要对SDS进行空间扩展的时候，程序不仅会为SDS**分配修改需要的空间**，还会为SDS分配额外的**未使用空间**。

   通过这种预分配策略，SDS将连续增长N次字符串所需的内存分配次数从**必定N次**降低为**最多N次**。

1. 惰性空间释放

   惰性空间释放用于优化SDS的字符串缩短操作：当SDS的API需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用**`free`属性将这些字节的数量记录起来**，并等待使用。

   这种空间释放策略避免了缩短字符串时需要的内存重分配操作，并为将来可能有的增长操作提供了优化。

### 二进制安全

C字符串中的字符必须符合某种编码（比如ASCII），这使得C字符串只能保存文本数据，而不能保存二进制数据。

而SDS API会以处理二进制的方式来处理存放在`buf`数组里的数据.

这也是称`buf`属性为字节数组的原因——保存的是一系列二进制数据