# Redis——整数集合intset

整数集合是集合的底层实现之一。

当一个集合**只包含整数值元素**，并且这个集合的元素数量不多时，Redis就会使用整数集合作为集合的底层实现。

## 整数集合的实现

整数集合可以保存类型为`int16_t`、`int32_t`、`int64_t`的整数值，并且保证集合中不会出现重复元素。

```c
typedef struct intset{
    //编码方式
    uint32_t encoding;
    //集合包含的元素数量
    uint32_t length;
    //保存元素的数组
    int8_t contents[];
}intset;
```

**`contents`数组中的元素按值的大小从小到大有序排列**

针对`intset`结构体的各个属性，有几点需要说明

1. 虽然`contents`属性被声明为`int8_t`类型的数组，但数组的真正类型取决于`encoding`属性的值
1. `encoding`属性的值可以为`INTSET_ENC_INT16`、`INTSET_ENC_INT32`、`INTSET_ENC_INT64`，`contents`数组类型分别对应`int16_t`、`int32_t`、`int64_t`

## 整数集合的升级

当新加入的元素类型比整数集合内现有的所有元素类型都要长时，就需要先升级才能将新元素添加到整数集合内。

**升级整数元素并添加新元素的步骤：**

1. 根据新元素的类型，扩展底层数组的空间大小，并为新元素分配空间

> 比如将一个int32_t的整数值加入到`INTSET_ENC_INT16`编码的整数集合中，首先需要根据新类型的长度，以及集合元素的数量（包括要添加的新元素），对数组进行空间重分配

2. 将底层数组的现有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位置上（仍需保持数组的有序性）
2. 添加新元素到底层数组中

> 新元素的摆放位置只会有两种情况：大于所有的现有元素和小于所有的现有元素

## 升级策略的好处

1. 提升整数集合的灵活性
1. 尽可能节约内存

最后，整数集合不支持降级的操作，一旦升级，编码就一直保持升级后的状态